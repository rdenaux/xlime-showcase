<!--
@license
Copyright (c) 2016 Expert System. All rights reserved.
This code may only be used under the BSD style license.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/xlime-polymer-elements/xlime-spheres.html">
<link rel="import" href="../showcase-resource-selector/showcase-resource-selector.html">
<link rel="import" href="showcase-resource.html">

<dom-module id="my-spheres">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      span,
      input {
        @apply(--paper-font-body2);
      }

     paper-fab {
       position: absolute;
         z-index: 20;
         color: black;
     }
     paper-spinner {
         position: absolute;
         z-indx: 20;
     }
     xlime-spheres {
       width: 630px;
       height: 630px;
     }
    </style>

    <paper-fab icon="add" title="add information to your context to browse cross-modally and cross-lingually" on-tap="_onAddContextElementTap"></paper-fab>
    <iron-ajax id="spheresAjax" url="[[baseXlimeServiceUrl]]/services/spheres" params='{"context": []}' last-response="{{latestSpheres}}"
               loading="{{_latestSpheresLoading}}"></iron-ajax>
    <paper-spinner alt="Loading spheres" class="center" active="[[_latestSpheresLoading]]">Loading spheres...</paper-spinner>
    <xlime-spheres id="spheres" obj="{{latestSpheres}}" selected="{{selectedInSphere}}" on-spheres-resource-removed="_onSpheresResourceRemoved"></xlime-spheres>
    <paper-dialog id="addContextDialog" on-iron-overlay-closed="_handleAddContextDialogClosed">
        <showcase-resource-selector selected-resource="{{resourceToAdd}}">
        </showcase-resource-selector>
        <!-- 
        <div>Resource to Add: [[resourceToAdd.url]]</div>
         -->
        <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm disabled$="[[!resourceToAdd]]" autofocus>Add</paper-button>
        </div>
    </paper-dialog>
    <!-- 
    <span>Selected in sphere: [[selectedInSphere.url]]</span>
     -->
    <showcase-resource resource="{{selectedInSphere}}">
    </showcase-resource>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'my-spheres',

        properties: {
          resourceToAdd: {
            type: Object,
            value: null,
              listener: '_handleResourceToAddChange'
          },

          baseXlimeServiceUrl: {
              type: String,
              value: "http://localhost:8080"
          }
            
        },

        _onAddContextElementTap: function(e, detail) {
           this.$.addContextDialog.open();
        },

        _onSpheresResourceRemoved: function(e, detail) {
            var context = [];
            if (this.latestSpheres && this.latestSpheres.inner) {
                for (var i = 0; i < this.latestSpheres.inner.length; i++) {
                    var rec = this.latestSpheres.inner[i].recommended;
                    if (rec && rec.url) {
                        context.push(rec.url);
                    }
                }
            }
            var params = {
                context: context
            }
            console.log("Calling spheres with context: ", params);
            this.$.spheresAjax.params = params;
            this.$.spheresAjax.generateRequest();
        },
          
        _handleResourceToAddChange: function(e, detail) {
          console.log("Resource to add changed: ", this.resourceToAdd);
        },
          
        _handleAddContextDialogClosed: function(closingReason) {
            console.log("Dialog closed with reason", closingReason);
            if (closingReason.detail && closingReason.detail.confirmed) {
                //   this.spheres.addToInner(this.resourceToAdd);
                var context = [];
                if (this.latestSpheres && this.latestSpheres.inner) {
                    for (var i = 0; i < this.latestSpheres.inner.length; i++) {
                        var rec = this.latestSpheres.inner[i].recommended;
                        if (rec && rec.url) {
                            context.push(rec.url);
                        }
                    }
                }
                context.push(this.resourceToAdd.url);
                var params = {
                    context: context
                }
                console.log("Calling spheres with context: ", params);
                this.$.spheresAjax.params = params;
                this.$.spheresAjax.generateRequest();
            }
        }
          
      });
    })();
  </script>
</dom-module>
