<!--
@license
Copyright (c) 2016 Expert System. All rights reserved.
This code may only be used under the BSD style license.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/xlime-polymer-elements/xlime-spheres.html">
<link rel="import" href="../showcase-resource-selector/showcase-resource-selector.html">
<link rel="import" href="showcase-resource.html">

<dom-module id="my-spheres">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      span,
      input {
        @apply(--paper-font-body2);
      }

     paper-fab  {
         z-index: 20;
         color: black;
     }

     #searchfab {
         position: absolute;
         left: 0;
     }
     #searchfab {
         position: absolute;
         left: 70;
     }
     
     paper-spinner {
         position: absolute;
         z-indx: 20;
     }
     xlime-spheres {
       width: 630px;
       height: 630px;
     }

     #spheres-card {
       min-width: 650px;
       min-height: 650px;
     }

     xlime-spheres {
         display: inline-block;
         float: left;
     }

     showcase-resource  {
         display: inline-block;
         float: left;
         max-width: 500px;
         padding-left: 2em;
     }
     
    </style>

    <paper-fab id="searchfab" icon="search" title="Search for media items and add results to the spheres context" on-tap="_onSearchElementTap"></paper-fab>
    <paper-fab id="recentfab" icon="alarm" title="Browse recently published media items and add selected items to the spheres context" on-tap="_onRecentElementTap"></paper-fab>    
    <paper-material id="spheres-card" elevation="1">
        <iron-ajax id="spheresAjax" url="[[baseXlimeServiceUrl]]/services/spheres" params='{"context": []}' last-response="{{latestSpheres}}"
               loading="{{_latestSpheresLoading}}"></iron-ajax>
        <paper-spinner alt="Loading spheres" class="center" active="[[_latestSpheresLoading]]">Loading spheres...</paper-spinner>
        <xlime-spheres id="spheres" obj="{{latestSpheres}}" selected="{{selectedInSphere}}" on-spheres-resource-removed="_onSpheresResourceRemoved"></xlime-spheres>
        <showcase-resource base-xlime-service-url="[[baseXlimeServiceUrl]]" resource="{{selectedInSphere}}">
        </showcase-resource>
    </paper-material>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'my-spheres',

        properties: {
          resourceToAdd: {
            type: Object,
            value: null,
              listener: '_handleResourceToAddChange'
          },
          /**
           * Base url used to call an xLiMe frontend-services endpoint. In this element, 
           * this is used for loading the spheres and for displaying additional information 
           * for selected resources.
           */
          baseXlimeServiceUrl: String
            
        },

    created: function() {
        console.log(this.localName + '#' + this.id + ' was created');
    },
      
    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
        // necessary), or kick off any processes the element wants to perform.
        //console.log("The jassa attribute ", _jassa);
        console.log("ready The baseXlimeServiceUrl attribute ", this.baseXlimeServiceUrl);
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
        console.log("attached The baseXlimeServiceUrl attribute ", this.baseXlimeServiceUrl);
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },
          
        _onAddContextElementTap: function(e, detail) {
           this.$.addContextDialog.open();
        },

        _onSearchElementTap: function(e, detail) {
            page('/search');
        },

        _onRecentElementTap: function(e, detail) {
              page('/recent');
        },
          
        _onSpheresResourceRemoved: function(e, detail) {
            var context = [];
            if (this.latestSpheres && this.latestSpheres.inner) {
                for (var i = 0; i < this.latestSpheres.inner.length; i++) {
                    var rec = this.latestSpheres.inner[i].recommended;
                    if (rec && rec.url) {
                        context.push(rec.url);
                    }
                }
            }
            var params = {
                context: context
            }
            console.log("Calling spheres with context: ", params);
            this.$.spheresAjax.params = params;
            this.$.spheresAjax.generateRequest();
        },
          
        _handleResourceToAddChange: function(e, detail) {
          console.log("Resource to add changed: ", this.resourceToAdd);
        },
          
        _handleAddContextDialogClosed: function(closingReason) {
            console.log("Dialog closed with reason", closingReason);
            if (closingReason.detail && closingReason.detail.confirmed) {
                console.debug("")
                this.addToSpheres(this.resourceToAdd);
            }
        },
        addToSpheres: function(resToAdd) {
            //   this.spheres.addToInner(resToAdd);
            var context = [];
            if (this.latestSpheres && this.latestSpheres.inner) {
                for (var i = 0; i < this.latestSpheres.inner.length; i++) {
                    var rec = this.latestSpheres.inner[i].recommended;
                    if (rec && rec.url) {
                        context.push(rec.url);
                    }
                }
            }
            context.push(resToAdd.url);
            var params = {
                context: context
            }
            console.log("Calling spheres with context: ", params);
            this.$.spheresAjax.params = params;
            this.$.spheresAjax.generateRequest();
        }
      });
    })();
  </script>
</dom-module>
